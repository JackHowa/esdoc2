<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/ESDoc.js | esdoc2</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Better Documentation Generator For JavaScript"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="esdoc2"><meta property="twitter:description" content="Better Documentation Generator For JavaScript"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/esdoc2/esdoc2"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ESDoc.js~ESDoc.html">ESDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ESDocCLI.js~ESDocCLI.html">ESDocCLI</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#doc">Doc</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/AbstractDoc.js~AbstractDoc.html">AbstractDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/AssignmentDoc.js~AssignmentDoc.html">AssignmentDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/ClassDoc.js~ClassDoc.html">ClassDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/ClassPropertyDoc.js~ClassPropertyDoc.html">ClassPropertyDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/ExternalDoc.js~ExternalDoc.html">ExternalDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/FileDoc.js~FileDoc.html">FileDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/FunctionDoc.js~FunctionDoc.html">FunctionDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/MemberDoc.js~MemberDoc.html">MemberDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/MethodDoc.js~MethodDoc.html">MethodDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/TypedefDoc.js~TypedefDoc.html">TypedefDoc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Doc/VariableDoc.js~VariableDoc.html">VariableDoc</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#factory">Factory</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Factory/DocFactory.js~DocFactory.html">DocFactory</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#parser">Parser</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Parser/CommentParser.js~CommentParser.html">CommentParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Parser/ESParser.js~ESParser.html">ESParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Parser/ParamParser.js~ParamParser.html">ParamParser</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugin">Plugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Plugin/Plugin.js~Plugin.html">Plugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Plugin/Plugin.js~PluginEvent.html">PluginEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-plugin">plugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#typedef">Typedef</a><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-AST">AST</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ASTNode">ASTNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-CoverageObject">CoverageObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DocObject">DocObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DocTypedef">DocTypedef</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ESDocCLIArgv">ESDocCLIArgv</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ESDocConfig">ESDocConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-IceCap">IceCap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-IceCapInstanceTypedef">IceCapInstanceTypedef</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ManualConfigItem">ManualConfigItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NPMPackageObject">NPMPackageObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PackageTypedef">PackageTypedef</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ParsedParam">ParsedParam</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Taffy">Taffy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-TaffyCursor">TaffyCursor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Tag">Tag</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#util">Util</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Util/ASTNodeContainer.js~ASTNodeContainer.html">ASTNodeContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Util/ASTUtil.js~ASTUtil.html">ASTUtil</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Util/InvalidCodeLogger.js~InvalidCodeLogger.html">InvalidCodeLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Util/NPMUtil.js~NPMUtil.html">NPMUtil</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Util/NamingUtil.js~NamingUtil.html">NamingUtil</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Util/PathResolver.js~PathResolver.html">PathResolver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aSTNodeContainer">aSTNodeContainer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-invalidCodeLogger">invalidCodeLogger</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/ESDoc.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import fs from &apos;fs-extra&apos;;
import path from &apos;path&apos;;
import assert from &apos;assert&apos;;
import ASTUtil from &apos;./Util/ASTUtil.js&apos;;
import ESParser from &apos;./Parser/ESParser&apos;;
import PathResolver from &apos;./Util/PathResolver.js&apos;;
import DocFactory from &apos;./Factory/DocFactory.js&apos;;
import InvalidCodeLogger from &apos;./Util/InvalidCodeLogger.js&apos;;
import Plugin from &apos;./Plugin/Plugin.js&apos;;
import {Transform} from &apos;stream&apos;;
import json from &apos;big-json&apos;;
import mkdirp from &apos;mkdirp&apos;;
import log from &apos;npmlog&apos;;

/**
 * API Documentation Generator.
 *
 * @example
 * let config = {source: &apos;./src&apos;, destination: &apos;./esdoc2&apos;};
 * esdoc2.generate(config, (results, config)=&gt;{
 *   console.log(results);
 * });
 */
export default class ESDoc {
  /**
   * Generate documentation.
   * @param {ESDocConfig} config - config for generation.
   */
  static generate(config) {
    return new Promise((resolve) =&gt; {
      assert(config.source);
      assert(config.destination);

      this._checkOldConfig(config);

      Plugin.init(config.plugins);
      Plugin.onStart();
      config = Plugin.onHandleConfig(config);

      this._setDefaultConfig(config);

      const includes = config.includes.map((v) =&gt; new RegExp(v));
      const excludes = config.excludes.map((v) =&gt; new RegExp(v));

      let packageName = null;
      let mainFilePath = null;
      if (config.package) {
        try {
          const packageJSON = fs.readFileSync(config.package, {encode: &apos;utf8&apos;});
          const packageConfig = JSON.parse(packageJSON);
          packageName = packageConfig.name;
          mainFilePath = packageConfig.main;
        } catch (e) {
        // ignore
        }
      }

      let results = [];
      const sourceDirPath = path.resolve(config.source);
      const onWriteFinish = () =&gt; {
        log.info(&apos;esdoc2&apos;, &apos;finished generating files&apos;);

        // publish
        this._publish(config);

        Plugin.onComplete();

        this._memUsage();
        resolve(true);
      };

      const fatalError = err =&gt; {
        log.error(err);
        process.exit(1);
      };

      const stringifyWriteTransform = new Transform({
        writableObjectMode: true,
        readableObjectMode: true,
        transform: function(chunk, encoding, transformCallback) {
          const fullPath = path.resolve(config.destination, `ast/${chunk.filePath}.json`);
          mkdirp(fullPath.split(&apos;/&apos;).slice(0, -1).join(&apos;/&apos;), (err) =&gt; {
            if (err) fatalError(err);
            log.verbose(&apos;transform&apos;, fullPath);
            const fileWriteStream = fs.createWriteStream(fullPath);
            fileWriteStream.on(&apos;error&apos;, fatalError);
            fileWriteStream.on(&apos;finish&apos;, () =&gt; log.verbose(&apos;write&apos;, fullPath));
            fileWriteStream.on(&apos;finish&apos;, transformCallback);

            const stringifyStream = json.createStringifyStream({body: chunk.ast});
            stringifyStream.on(&apos;error&apos;, fatalError);
            stringifyStream.on(&apos;end&apos;, fileWriteStream.end);
            stringifyStream.on(&apos;end&apos;, () =&gt; log.verbose(&apos;stringified&apos;, fullPath));
            stringifyStream.pipe(fileWriteStream);
          });
        }
      });

      stringifyWriteTransform.on(&apos;finish&apos;, onWriteFinish);
      stringifyWriteTransform.on(&apos;error&apos;, fatalError);

      this._walk(config.source, (filePath) =&gt; {
        const relativeFilePath = path.relative(sourceDirPath, filePath);
        let match = false;
        for (const reg of includes) {
          if (relativeFilePath.match(reg)) {
            match = true;
            break;
          }
        }
        if (!match) return;

        for (const reg of excludes) {
          if (relativeFilePath.match(reg)) return;
        }

        log.info(&apos;parse&apos;, filePath);
        const temp = this._traverse(config.source, filePath, packageName, mainFilePath);
        if (!temp) return;
        results.push(...temp.results);
        stringifyWriteTransform.write({filePath: `source${path.sep}${relativeFilePath}`, ast: temp.ast});
      });

      stringifyWriteTransform.end();

      // config.index
      if (config.index) {
        results.push(this._generateForIndex(config));
      }

      // config.package
      if (config.package) {
        results.push(this._generateForPackageJSON(config));
      }

      results = this._resolveDuplication(results);

      results = Plugin.onHandleDocs(results);

      // index.json
      {
        const dumpPath = path.resolve(config.destination, &apos;index.json&apos;);
        fs.outputFileSync(dumpPath, JSON.stringify(results, null, 2));
      }
    });
  }

  /**
   * check esdoc2 config. and if it is old, exit with warning message.
   * @param {ESDocConfig} config - check config
   * @private
   */
  static _checkOldConfig(config) {
    let exit = false;

    const keys = [
      [&apos;access&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;autoPrivate&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;unexportIdentifier&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;undocumentIdentifier&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;builtinExternal&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;coverage&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;test&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;title&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;manual&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;lint&apos;, &apos;esdoc2-standard-plugin&apos;],
      [&apos;includeSource&apos;, &apos;esdoc2-exclude-source-plugin&apos;],
      [&apos;styles&apos;, &apos;esdoc2-inject-style-plugin&apos;],
      [&apos;scripts&apos;, &apos;esdoc2-inject-script-plugin&apos;],
      [&apos;experimentalProposal&apos;, &apos;esdoc2-ecmascript-proposal-plugin&apos;]
    ];

    for (const [key, plugin] of keys) {
      if (key in config) {
        console.error(`[31merror: config.${key} is invalid. Please use ${plugin}. how to migration: https://esdoc2.org/manual/migration.html[0m`);
        exit = true;
      }
    }

    if (exit) process.exit(1);
  }

  /**
   * set default config to specified config.
   * @param {ESDocConfig} config - specified config.
   * @private
   */
  static _setDefaultConfig(config) {
    if (!config.includes) config.includes = [&apos;\\.js$&apos;];

    if (!config.excludes) config.excludes = [&apos;\\.config\\.js$&apos;, &apos;\\.test\\.js$&apos;];

    if (!config.index) config.index = &apos;./README.md&apos;;

    if (!config.package) config.package = &apos;./package.json&apos;;
  }

  /**
   * walk recursive in directory.
   * @param {string} dirPath - target directory path.
   * @param {function(entryPath: string)} callback - callback for find file.
   * @private
   */
  static _walk(dirPath, callback) {
    const entries = fs.readdirSync(dirPath);

    for (const entry of entries) {
      const entryPath = path.resolve(dirPath, entry);
      const stat = fs.statSync(entryPath);

      if (stat.isFile()) {
        callback(entryPath);
      } else if (stat.isDirectory()) {
        this._walk(entryPath, callback);
      }
    }
  }

  /**
   * traverse doc comment in JavaScript file.
   * @param {string} inDirPath - root directory path.
   * @param {string} filePath - target JavaScript file path.
   * @param {string} [packageName] - npm package name of target.
   * @param {string} [mainFilePath] - npm main file path of target.
   * @returns {Object} - return document that is traversed.
   * @property {DocObject[]} results - this is contained JavaScript file.
   * @property {AST} ast - this is AST of JavaScript file.
   * @private
   */
  static _traverse(inDirPath, filePath, packageName, mainFilePath) {
    log.verbose(`parsing: ${filePath}`);
    let ast;
    try {
      ast = ESParser.parse(filePath);
    } catch (e) {
      InvalidCodeLogger.showFile(filePath, e);
      return null;
    }

    const pathResolver = new PathResolver(inDirPath, filePath, packageName, mainFilePath);
    const factory = new DocFactory(ast, pathResolver);

    ASTUtil.traverse(ast, (node, parent) =&gt; {
      try {
        factory.push(node, parent);
      } catch (e) {
        InvalidCodeLogger.show(filePath, node);
        throw e;
      }
    });

    return {results: factory.results, ast: ast};
  }

  /**
   * generate index doc
   * @param {ESDocConfig} config
   * @returns {Tag}
   * @private
   */
  static _generateForIndex(config) {
    const indexContent = fs.readFileSync(config.index, {encode: &apos;utf8&apos;}).toString();
    const tag = {
      kind: &apos;index&apos;,
      content: indexContent,
      longname: path.resolve(config.index),
      name: config.index,
      static: true,
      access: &apos;public&apos;
    };

    return tag;
  }

  /**
   * generate package doc
   * @param {ESDocConfig} config
   * @returns {Tag}
   * @private
   */
  static _generateForPackageJSON(config) {
    let packageJSON = &apos;&apos;;
    let packagePath = &apos;&apos;;
    try {
      packageJSON = fs.readFileSync(config.package, {encoding: &apos;utf-8&apos;});
      packagePath = path.resolve(config.package);
    } catch (e) {
      // ignore
    }

    const tag = {
      kind: &apos;packageJSON&apos;,
      content: packageJSON,
      longname: packagePath,
      name: path.basename(packagePath),
      static: true,
      access: &apos;public&apos;
    };

    return tag;
  }

  /**
   * resolve duplication docs
   * @param {Tag[]} docs
   * @returns {Tag[]}
   * @private
   */
  static _resolveDuplication(docs) {
    const memberDocs = docs.filter((doc) =&gt; doc.kind === &apos;member&apos;);
    const removeIds = [];

    for (const memberDoc of memberDocs) {
      // member duplicate with getter/setter/method.
      // when it, remove member.
      // getter/setter/method are high priority.
      const sameLongnameDoc = docs.find((doc) =&gt; doc.longname === memberDoc.longname &amp;&amp; doc.kind !== &apos;member&apos;);
      if (sameLongnameDoc) {
        removeIds.push(memberDoc.__docId__);
        continue;
      }

      const dup = docs.filter((doc) =&gt; doc.longname === memberDoc.longname &amp;&amp; doc.kind === &apos;member&apos;);
      if (dup.length &gt; 1) {
        const ids = dup.map(v =&gt; v.__docId__);
        ids.sort((a, b) =&gt; {
          return a &lt; b ? -1 : 1;
        });
        ids.shift();
        removeIds.push(...ids);
      }
    }

    return docs.filter((doc) =&gt; !removeIds.includes(doc.__docId__));
  }

  /**
   * publish content
   * @param {ESDocConfig} config
   * @private
   */
  static _publish(config) {
    try {
      const write = (filePath, content, option) =&gt; {
        const _filePath = path.resolve(config.destination, filePath);
        content = Plugin.onHandleContent(content, _filePath);
        
        log.info(&apos;write&apos;, _filePath);
        fs.outputFileSync(_filePath, content, option);
      };

      const copy = (srcPath, destPath) =&gt; {
        const _destPath = path.resolve(config.destination, destPath);
        log.info(&apos;copy&apos;, _destPath);
        fs.copySync(srcPath, _destPath);
      };

      const read = (filePath) =&gt; {
        const _filePath = path.resolve(config.destination, filePath);
        return fs.readFileSync(_filePath).toString();
      };

      Plugin.onPublish(write, copy, read);
    } catch (e) {
      InvalidCodeLogger.showError(e);
      process.exit(1);
    }
  }

  /**
   * show memory usage stat
   * @return {undefined} no return
   */
  static _memUsage() {
    const used = process.memoryUsage();
    Object.keys(used).forEach(key =&gt; {
      log.verbose(`${key} ${Math.round(used[key] / 1024 / 1024 * 100) / 100} MB`);
    });
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc2.org">esdoc2<span data-ice="esdocVersion">(2.0.0-4)</span><img src="./image/esdoc2-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
